<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>已付款客戶｜近六個月</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#fafafa;color:#111}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{margin:0 0 6px;font-size:32px}
    .sub{color:#666;margin-bottom:18px}

    .cards{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin:16px 0}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:14px;padding:16px}
    .card .t{font-size:14px;color:#666;margin-bottom:8px}
    .card .v{font-size:36px;font-weight:800}

    .bar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
    .btn{border-radius:999px;padding:10px 16px;border:1px solid #111;background:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:#111;color:#fff}

    .meta{margin:10px 0;color:#666;font-size:14px}

    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #eee;font-size:14px;text-align:left}
    th{background:#fafafa;color:#666}

    .err{margin-top:16px;background:#fff3f3;border:1px solid #ffd1d1;color:#b00020;padding:14px;border-radius:12px;font-weight:700;white-space:pre-wrap}

    @media(max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:500px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <h1>已付款客戶｜近六個月</h1>
  <div class="sub">規則：預約日期「包含退費」=退費；「包含改期」=改期；空白=未預約</div>

  <div class="cards">
    <div class="card"><div class="t">已付款總數</div><div class="v" id="kpiPaidTotal">-</div></div>
    <div class="card"><div class="t">未預約</div><div class="v" id="kpiNotBooked">-</div></div>
    <div class="card"><div class="t">退費</div><div class="v" id="kpiRefund">-</div></div>
    <div class="card"><div class="t">改期</div><div class="v" id="kpiRescheduled">-</div></div>
    <div class="card"><div class="t">已預約</div><div class="v" id="kpiBooked">-</div></div>
  </div>

  <div class="bar">
    <button class="btn primary" data-status="not_booked">未預約</button>
    <button class="btn" data-status="refund">退費</button>
    <button class="btn" data-status="rescheduled">改期</button>
    <button class="btn" data-status="booked">已預約</button>
    <button class="btn" data-status="paid_all">全部</button>
    <button class="btn" id="btnRefresh">重新整理</button>
  </div>

  <div class="meta" id="meta">讀取中…</div>

  <table>
    <thead>
      <tr>
        <th style="width:140px">日期</th>
        <th style="width:220px">預約日期</th>
        <th style="width:120px">狀態</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="err" class="err" style="display:none"></div>
</div>

<script>
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb="cb_"+Math.random().toString(36).slice(2);
      const s=document.createElement("script");
      s.src=url+(url.includes("?")?"&":"?")+"callback="+cb+"&_ts="+Date.now();
      window[cb]=data=>{cleanup();resolve(data)};
      s.onerror=()=>{cleanup();reject(new Error("JSONP load failed: "+url))};
      function cleanup(){ try{delete window[cb]}catch(e){window[cb]=undefined} s.remove(); }
      document.body.appendChild(s);
      setTimeout(()=>{cleanup();reject(new Error("JSONP timeout: "+url))},15000);
    });
  }

  async function loadConfig(){
    const res = await fetch("config.json?_ts=" + Date.now(), { cache:"no-store" });
    if(!res.ok) throw new Error("讀不到 config.json（請確認與 index.html 同層）");
    const cfg = await res.json();
    if(!cfg.api) throw new Error("config.json 缺少 api");
    return cfg.api;
  }

  function esc(s){
    return String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }
  function setErr(msg){
    const e=document.getElementById("err");
    e.style.display="block";
    e.textContent="❌ "+msg;
  }
  function clearErr(){
    const e=document.getElementById("err");
    e.style.display="none";
    e.textContent="";
  }
  function setActive(status){
    document.querySelectorAll(".btn[data-status]").forEach(b=>{
      b.classList.toggle("primary", b.dataset.status===status);
    });
  }

  function render(items){
    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";
    items.forEach(it=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(it["日期"]||"")}</td>
        <td>${esc(it["預約日期"]||"")}</td>
        <td>${esc(it["狀態"]||"")}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  let current="not_booked";

  async function refresh(status){
    clearErr();
    document.getElementById("meta").textContent="讀取中…";

    const api = await loadConfig();

    const sum = await jsonp(api + "?action=summary");
    if(!sum.ok) throw new Error(sum.error || "summary failed");

    document.getElementById("kpiPaidTotal").textContent = sum.paidTotal ?? 0;
    document.getElementById("kpiNotBooked").textContent = sum.paidNotBooked ?? 0;
    document.getElementById("kpiRefund").textContent = sum.paidRefund ?? 0;
    document.getElementById("kpiRescheduled").textContent = sum.paidRescheduled ?? 0;
    document.getElementById("kpiBooked").textContent = sum.paidBooked ?? 0;

    const list = await jsonp(api + "?action=list&status=" + encodeURIComponent(status));
    if(!list.ok) throw new Error(list.error || "list failed");

    render(list.items || []);
    const ts = list.updatedAt || sum.updatedAt;
    document.getElementById("meta").textContent =
      `狀態：${status}｜筆數：${list.count ?? (list.items||[]).length}｜更新：${new Date(ts).toLocaleString("zh-TW",{hour12:false})}`;
  }

  document.querySelectorAll(".btn[data-status]").forEach(b=>{
    b.addEventListener("click", ()=>{
      current = b.dataset.status;
      setActive(current);
      refresh(current).catch(e=>setErr(e.message||String(e)));
    });
  });

  document.getElementById("btnRefresh").addEventListener("click", ()=>{
    refresh(current).catch(e=>setErr(e.message||String(e)));
  });

  setActive(current);
  refresh(current).catch(e=>setErr(e.message||String(e)));
</script>
</body>
</html>
