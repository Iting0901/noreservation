<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>近六個月｜已付款客戶動態</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:#fff;color:#111}
    .wrap{max-width:1200px;margin:0 auto;padding:28px 18px 60px}
    h1{margin:0 0 6px;font-size:34px}
    .sub{color:#666;margin:0 0 18px}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:16px 0 14px}
    .card{border:1px solid #e6e6e6;border-radius:12px;padding:14px 16px}
    .card .t{color:#666;font-size:14px;margin-bottom:10px}
    .card .v{font-size:40px;font-weight:800;line-height:1}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .btn{border:1px solid #111;background:#fff;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:#111;color:#fff}
    .btn.ghost{border-color:#ddd;color:#111}
    .meta{color:#666;font-size:14px;margin:10px 0 12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #eee;padding:10px 8px;text-align:left;font-size:14px;vertical-align:top}
    th{color:#666;font-weight:700}
    .err{margin-top:14px;border:1px solid #ffd1d1;background:#fff3f3;color:#b00020;padding:12px 14px;border-radius:12px;font-weight:800;white-space:pre-wrap}
    @media (max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.cards{grid-template-columns:1fr} h1{font-size:28px}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>近六個月｜已付款客戶動態</h1>
    <p class="sub">統一資料庫單一分頁｜未預約 / 未聯繫 / 有改期</p>

    <div class="cards">
      <div class="card"><div class="t">已付款總數</div><div class="v" id="kpiPaidTotal">-</div></div>
      <div class="card"><div class="t">已付款未預約</div><div class="v" id="kpiNotBooked">-</div></div>
      <div class="card"><div class="t">已付款未聯繫</div><div class="v" id="kpiNotContacted">-</div></div>
      <div class="card"><div class="t">已付款有改期</div><div class="v" id="kpiRescheduled">-</div></div>
    </div>

    <div class="bar">
      <button class="btn primary" data-status="not_booked">未預約</button>
      <button class="btn" data-status="not_contacted">未聯繫</button>
      <button class="btn" data-status="rescheduled">有改期</button>
      <button class="btn ghost" data-status="all_paid">全部已付款</button>
      <button class="btn ghost" id="btnRefresh">重新整理</button>
    </div>

    <div class="meta" id="meta">狀態：-｜筆數：-｜更新：-</div>

    <table>
      <thead>
        <tr>
          <th style="width:160px">日期</th>
          <th style="width:160px">預約日期</th>
          <th>改期紀錄</th>
          <th>對帳紀錄</th>
          <th style="width:140px">狀態</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div id="err" class="err" style="display:none"></div>
  </div>

<script>
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const sep = url.includes("?") ? "&" : "?";
      const src = url + sep + "callback=" + cb + "&_ts=" + Date.now();
      const script = document.createElement("script");
      script.src = src;

      window[cb] = (data) => { cleanup(); resolve(data); };
      script.onerror = () => { cleanup(); reject(new Error("JSONP load failed: " + url)); };

      function cleanup() {
        try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        if (script.parentNode) script.parentNode.removeChild(script);
      }

      document.body.appendChild(script);
      setTimeout(() => { cleanup(); reject(new Error("JSONP timeout: " + url)); }, 15000);
    });
  }

  async function loadConfig() {
    const res = await fetch("config.json?_ts=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("讀不到 config.json（請確認放在 index.html 同層）");
    const cfg = await res.json();
    const api = cfg.api;
    if (!api) throw new Error("config.json 缺少 api");
    return { api };
  }

  function setErr(msg){ const el=document.getElementById("err"); el.style.display="block"; el.textContent="❌ 錯誤：\n"+msg; }
  function clearErr(){ const el=document.getElementById("err"); el.style.display="none"; el.textContent=""; }

  function setActive(status){
    document.querySelectorAll(".bar .btn").forEach(b=>{
      if (b.dataset && b.dataset.status) b.classList.toggle("primary", b.dataset.status===status);
    });
  }

  function renderTable(items){
    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";
    for(const it of items){
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(it["日期"]||"")}</td>
        <td>${esc(it["預約日期"]||"")}</td>
        <td>${esc(it["改期紀錄"]||"")}</td>
        <td>${esc(it["對帳紀錄"]||"")}</td>
        <td>${esc(it["狀態"]||"")}</td>
      `;
      tbody.appendChild(tr);
    }
  }
  function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function fmtLocal(iso){
    if(!iso) return "-";
    const d=new Date(iso);
    if(isNaN(d)) return iso;
    return d.toLocaleString("zh-TW",{hour12:false});
  }

  async function loadSummary(api){
    const u = api + "?action=summary";
    const a = await jsonp(u);
    if(!a.ok) throw new Error("summary 回傳非 ok：" + JSON.stringify(a));
    document.getElementById("kpiPaidTotal").textContent = a.paidTotal ?? 0;
    document.getElementById("kpiNotBooked").textContent = a.paidNotBooked ?? 0;
    document.getElementById("kpiNotContacted").textContent = a.paidNotContacted ?? 0;
    document.getElementById("kpiRescheduled").textContent = a.paidRescheduled ?? 0;
    return a.updatedAt;
  }

  async function loadList(api,status){
    const u = api + "?action=list&status=" + encodeURIComponent(status);
    const a = await jsonp(u);
    if(!a.ok) throw new Error("list 回傳非 ok：" + JSON.stringify(a));
    return a.items || [];
  }

  async function refreshAll(status){
    clearErr();
    const meta=document.getElementById("meta");
    meta.textContent="讀取中…";

    const cfg=await loadConfig();
    const updatedAt=await loadSummary(cfg.api);
    const items=await loadList(cfg.api,status);

    meta.textContent = `狀態：${status}｜筆數：${items.length}｜更新：${fmtLocal(updatedAt)}`;
    renderTable(items);
  }

  let currentStatus="not_booked";

  document.querySelectorAll(".bar .btn").forEach(btn=>{
    if(!btn.dataset || !btn.dataset.status) return;
    btn.addEventListener("click", async ()=>{
      currentStatus=btn.dataset.status;
      setActive(currentStatus);
      try{ await refreshAll(currentStatus); }catch(e){ setErr(e.message||String(e)); }
    });
  });

  document.getElementById("btnRefresh").addEventListener("click", async ()=>{
    try{ await refreshAll(currentStatus); }catch(e){ setErr(e.message||String(e)); }
  });

  (async ()=>{
    setActive(currentStatus);
    try{ await refreshAll(currentStatus); }catch(e){ setErr(e.message||String(e)); }
  })();
</script>
</body>
</html>
