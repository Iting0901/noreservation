<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>付款未預約動態 Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;padding:22px}
    h1{margin:0 0 6px}
    .sub{color:#555;margin:0 0 14px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:14px 0}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .k{font-size:12px;color:#666}
    .v{font-size:28px;font-weight:800;margin-top:4px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .tab{border:1px solid #111;border-radius:999px;padding:8px 12px;cursor:pointer;background:#fff}
    .tab.active{background:#111;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:14px}
    th{font-size:12px;color:#666}
    .meta{color:#666;font-size:12px;margin-top:10px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
  </style>
</head>
<body>
  <h1>近六個月｜已付款客戶動態</h1>
  <div class="sub">加總 2025 + 2026 兩份資料庫｜狀態：未預約／未聯繫／有改期</div>

  <div class="grid">
    <div class="card"><div class="k">已付款總數</div><div class="v" id="paidTotal">-</div></div>
    <div class="card"><div class="k">已付款未預約</div><div class="v" id="paidNotBooked">-</div></div>
    <div class="card"><div class="k">已付款未聯繫</div><div class="v" id="paidNotContacted">-</div></div>
    <div class="card"><div class="k">已付款有改期</div><div class="v" id="paidRescheduled">-</div></div>
  </div>

  <div class="tabs">
    <button class="tab active" data-status="not_booked">未預約</button>
    <button class="tab" data-status="not_contacted">未聯繫</button>
    <button class="tab" data-status="rescheduled">有改期</button>
    <button class="tab" data-status="all_paid">全部已付款</button>
    <button class="tab" id="refreshBtn">重新整理</button>
  </div>

  <div class="meta" id="meta">載入中…</div>

  <table>
    <thead>
      <tr>
        <th>資料庫</th>
        <th>日期</th>
        <th>預約日期</th>
        <th>改期紀錄</th>
        <th>對帳紀錄</th>
        <th>狀態</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
  const CONFIG_URL = "./config.json";

  function set(id, v){ document.getElementById(id).textContent = v; }

  // JSONP（不會 CORS）
  function jsonp(url, params) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const qs = new URLSearchParams({ ...params, callback: cb }).toString();
      const s = document.createElement("script");
      const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 12000);

      function cleanup() {
        clearTimeout(timer);
        delete window[cb];
        s.remove();
      }

      window[cb] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("load error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + qs;
      document.body.appendChild(s);
    });
  }

  async function loadConfig(){
    const res = await fetch(CONFIG_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("config.json 讀不到");
    return res.json();
  }

  function renderRows(rows){
    const tb = document.getElementById("tbody");
    tb.innerHTML = rows.map(r => `
      <tr>
        <td>${esc(r._db)}</td>
        <td>${esc(r["日期"] || "")}</td>
        <td>${esc(r["預約日期"] || "")}</td>
        <td>${esc(r["改期紀錄"] || "")}</td>
        <td>${esc(r["對帳紀錄"] || "")}</td>
        <td>${esc(r["狀態"] || "")}</td>
      </tr>
    `).join("");
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  let CFG = null;
  let CURRENT_STATUS = "not_booked";

  async function refreshAll(){
    if(!CFG) CFG = await loadConfig();

    const urls = [
      { db:"2025", url: CFG.db2025 },
      { db:"2026", url: CFG.db2026 }
    ];

    // KPI
    const sums = { paidTotal:0, paidNotBooked:0, paidNotContacted:0, paidRescheduled:0 };
    const summaries = await Promise.all(urls.map(x => jsonp(x.url, { action:"summary" }).catch(() => null)));

    summaries.forEach(s => {
      if(!s || !s.ok) return;
      sums.paidTotal += s.paidTotal || 0;
      sums.paidNotBooked += s.paidNotBooked || 0;
      sums.paidNotContacted += s.paidNotContacted || 0;
      sums.paidRescheduled += s.paidRescheduled || 0;
    });

    set("paidTotal", sums.paidTotal);
    set("paidNotBooked", sums.paidNotBooked);
    set("paidNotContacted", sums.paidNotContacted);
    set("paidRescheduled", sums.paidRescheduled);

    await refreshList(CURRENT_STATUS);
  }

  async function refreshList(status){
    if(!CFG) CFG = await loadConfig();
    CURRENT_STATUS = status;

    const urls = [
      { db:"2025", url: CFG.db2025 },
      { db:"2026", url: CFG.db2026 }
    ];

    const lists = await Promise.all(urls.map(x =>
      jsonp(x.url, { action:"list", status }).then(d => ({db:x.db, d})).catch(() => ({db:x.db, d:null}))
    ));

    let rows = [];
    lists.forEach(x => {
      if(!x.d || !x.d.ok) return;
      (x.d.items || []).forEach(it => rows.push({ _db: x.db, ...it }));
    });

    // 讓最新日期在前（字串 yyyy/MM/dd 可直接比）
    rows.sort((a,b) => String(b["日期"]||"").localeCompare(String(a["日期"]||"")));

    renderRows(rows);
    document.getElementById("meta").textContent =
      `狀態：${status}｜筆數：${rows.length}｜更新：${new Date().toLocaleString()}`;
  }

  // Tabs
  document.querySelectorAll(".tab[data-status]").forEach(btn => {
    btn.addEventListener("click", async () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      btn.classList.add("active");
      await refreshList(btn.dataset.status);
    });
  });

  document.getElementById("refreshBtn").addEventListener("click", refreshAll);

  // 自動更新（每 3 分鐘）
  refreshAll();
  setInterval(refreshAll, 3 * 60 * 1000);
</script>
</body>
</html>
